<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:sec="http://www.springframework.org/schema/security"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.springframework.org/schema/security
          http://www.springframework.org/schema/security/spring-security.xsd">

    <bean id="passwordEncoder"
          class="com.wisemapping.security.DefaultPasswordEncoderFactories"
          factory-method="createDelegatingPasswordEncoder"
    />

    <sec:http entry-point-ref="casAuthenticationEntryPoint" use-expressions="true">
        <sec:intercept-url pattern="/**" access="isAuthenticated() and hasRole('ROLE_USER')"/>
        <sec:custom-filter ref="singleSignOutFilter" before="CAS_FILTER"/>
        <sec:custom-filter ref="casAuthenticationFilter" position="CAS_FILTER"/>
        <sec:logout invalidate-session="true" delete-cookies="JSESSIONID"/>
        <sec:csrf disabled="true"/>
    </sec:http>

    <sec:authentication-manager alias="authenticationManager">
        <sec:authentication-provider ref="casAuthenticationProvider"/>
    </sec:authentication-manager>

    <bean id="casUserDetailsService"
          class="com.wisemapping.security.cas.CasUserDetailsService"
          p:userService-ref="userService"
    />

    <bean id="serviceProperties"
          class="org.springframework.security.cas.ServiceProperties"
          p:service="${security.cas.authUriFilterPath}"
          p:sendRenew="false"
          p:authenticateAllArtifacts="true"
    />

    <bean id="serviceUrlHelper"
          class="com.wisemapping.service.ServiceUrlHelper"
    >
        <constructor-arg value="${server.servlet.contextPath}"/>
        <constructor-arg value="#{'${security.cas.authorizedDomainNames}'.split(',')}"/>
        <constructor-arg value="${security.cas.protocol}"/>
        <constructor-arg value="/view/item/"/>
    </bean>

    <bean id="casAuthenticationProvider"
          class="com.wisemapping.security.cas.RememberCasAuthenticationProvider"
          p:authenticationUserDetailsService-ref="casUserDetailsService"
          p:serviceProperties-ref="serviceProperties"
          p:ticketValidator-ref="cas20ServiceTicketValidator"
          p:key="${security.cas.id-key-provider}"
    />

    <bean id="sessionStrategy"
          class="com.wisemapping.security.cas.CustomSessionFixationProtectionStrategy"
          p:migrateSessionAttributes="false"
    >
        <constructor-arg ref="serviceUrlHelper"/>
        <constructor-arg ref="serviceProperties"/>
        <constructor-arg value="${security.cas.redirectParamName}"/>
    </bean>

    <bean id="cas20ServiceTicketValidator"
          class="org.jasig.cas.client.validation.Cas20ServiceTicketValidator"
    >
        <constructor-arg value="${security.cas.url.prefix}"/>
    </bean>

    <bean id="rememberWebAuthenticationDetailsSource"
          class="com.wisemapping.security.cas.RememberWebAuthenticationDetailsSource"
    >
        <constructor-arg ref="serviceUrlHelper"/>
        <constructor-arg ref="serviceProperties"/>
        <constructor-arg value="${security.cas.redirectParamName}"/>
    </bean>

    <bean id="casAuthenticationFilter"
          class="org.springframework.security.cas.web.CasAuthenticationFilter"
          p:filterProcessesUrl="/${security.cas.authUriFilterPath}"
          p:authenticationManager-ref="authenticationManager"
          p:sessionAuthenticationStrategy-ref="sessionStrategy"
          p:authenticationDetailsSource-ref="rememberWebAuthenticationDetailsSource"
    />

    <bean id="casAuthenticationEntryPoint"
          class="com.wisemapping.security.cas.RememberCasAuthenticationEntryPoint"
          p:loginUrl="${security.cas.service.login}"
          p:serviceProperties-ref="serviceProperties"
          p:urlHelper-ref="serviceUrlHelper"
          p:pathLogin="/"
    />

    <bean id="singleSignOutFilter"
          class="com.wisemapping.security.cas.CustomSingleSignOutFilter"
          p:casServerUrlPrefix="${security.cas.url.prefix}"
    />

</beans>
